<% if @event.errors.any? %>
  <% @event.errors.full_messages.each do |err| %>
    <div class='error'>
      <%= err.html_safe %>
    </div>
  <% end %>
<% end %>
<%= form_for @event do |f| %>
  <span id='event' data='<%= @event.id %>' style='display: none'>Event</span>
  <%= f.label :title %>
  <%= f.text_field :title, required: true %>
  <br>
  <%= f.label :space_id %>
  <%= f.select :space_id, Space.all.collect{|s| [s.title, s.id] } %>
  <br>
  <%= f.label :custom_color %>
  <input class='js-custom-color' type='color' name='event[custom_color]' value='<%= @event.color %>'>
  <script> var colors = <%= Hash[EventType.all.map{|et| [et.title, et.color] }].to_json.html_safe %></script>
  <span class="swatch start">S</span>
  <span class="swatch middle">M</span>
  <span class="swatch end">E</span>
  <br>
  <%= f.label :event_style %>
  <%= f.select :event_style, ["Class", "Lecture", "Other - See Notes"], selected: "Class" %>
  <br>
  <%= f.label :event_type_id %>
  <%= f.select :event_type_id, EventType.all.collect{|et| [et.title, et.id] } %>
  <br>
  <%= f.label :start_date %>
  <input class='datetimepicker' name='event[start_date]' required="true" value="<%= @event.start_date%>" >
  <br>
  <%= f.label :end_date %>
  <input class='datetimepicker' name='event[end_date]' required="true" value="<%=@event.end_date %>">
  <br>
  <% unless @recurring_event %>
  <%= f.label :recurring_rules, "Recurring?" %>
  <%= f.select_recurring :recurring_rules, [
    IceCube::Rule.weekly.day(:monday, :wednesday),
    IceCube::Rule.weekly.day(:tuesday, :thursday),
    IceCube::Rule.weekly.day(:monday, :tuesday, :wednesday, :thursday, :friday)
    ], :allow_blank => true %>
  <br>
  <% end %>
  <%= f.label :producer %>
  <%= f.text_field :producer %>
  <br>
  <%= f.label :instructor %>
  <%= f.text_field :instructor %>
  <br>
  <%= f.label :number_of_attendees %>
  <%= f.number_field :number_of_attendees %>
  <br>
  <% if can? :approve, @event %>
  <%= f.label :approved %>
  <%= f.check_box :approved %>
  <br>
  <% end %>
  <h3>Notes</h3>
  <%= text_area_tag :notes %>
  <br>
  <%= f.submit %>
<% end %>
<script type="text/javascript">
  var url;
    
  $(".new_event").on("submit", function(e){
    e.preventDefault()
    var data = $(this).serialize()
    
    if ($("select#event_recurring_rules").val() === "null") {
      url = "/events"  + ".json"
    } else {
      url = "/recurring_events"  + ".json"
    }
    $.ajax({
      method: "post",
      url: url,
      data: data
    }).done(function(res){
      console.log("Response:", res);
      var d = moment(res.start_date).format("YYYY-MM-DD")
      window.location = "/days/"+ d
    }).fail(function(res){
      console.log("Response:", res);
    })
  })
</script>
